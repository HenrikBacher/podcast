name: Build and Release

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "tests/**"
      - "site/**"
      - "podcasts.json"
      - "Dockerfile"
      - ".github/workflows/build-and-release.yml"
  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - "tests/**"
      - "site/**"
      - "podcasts.json"
      - "Dockerfile"
      - ".github/workflows/build-and-release.yml"

env:
  DOTNET_VERSION: "10.0.x"
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version-tag: ${{ steps.version.outputs.version-tag }}
      is-release: ${{ steps.version.outputs.is-release }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) {
            $latestTag = "v0.1.0"
            Write-Host "No tags found, using default: $latestTag"
          } else {
            Write-Host "Latest version: $latestTag"
          }

          $version = $latestTag.TrimStart('v')
          $parts = $version -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]

          $isRelease = "false"
          $bumpType = "patch"

          if ("${{ github.event_name }}" -eq "push" -and "${{ github.ref }}" -eq "refs/heads/main") {
            $isRelease = "true"

            $commitMsg = git log -1 --pretty=%B
            $prMatch = $commitMsg -match '#(\d+)'
            if ($prMatch -and $matches -and $matches.Count -gt 1) {
              $prNumber = $matches[1]
              Write-Host "Merged PR #$prNumber"

              try {
                $prData = gh pr view $prNumber --json body --jq '.body' 2>$null
                if ($prData) {
                  if ($prData -match '\[x\]\s+\*\*Major\*\*') {
                    $bumpType = "major"
                  } elseif ($prData -match '\[x\]\s+\*\*Minor\*\*') {
                    $bumpType = "minor"
                  }
                }
              } catch {
                Write-Host "Could not read PR, using PATCH (default)"
              }
            }

            switch ($bumpType) {
              "major" { $newVersion = "$($major + 1).0.0" }
              "minor" { $newVersion = "$major.$($minor + 1).0" }
              "patch" { $newVersion = "$major.$minor.$($patch + 1)" }
            }
            $version = $newVersion
            Write-Host "Release: v$version ($bumpType)"
          } else {
            $prNumber = "${{ github.event.pull_request.number }}"
            if (-not $prNumber) { $prNumber = "0" }
            $shortSha = git rev-parse --short=7 HEAD

            $bumpType = "patch"
            try {
              $prBody = "${{ github.event.pull_request.body }}"
              if ($prBody -match '\[x\]\s+\*\*Major\*\*') { $bumpType = "major" }
              elseif ($prBody -match '\[x\]\s+\*\*Minor\*\*') { $bumpType = "minor" }
            } catch { }

            switch ($bumpType) {
              "major" { $nextVersion = "$($major + 1).0.0" }
              "minor" { $nextVersion = "$major.$($minor + 1).0" }
              "patch" { $nextVersion = "$major.$minor.$($patch + 1)" }
            }

            $version = "$nextVersion-pr$prNumber-$shortSha"
            Write-Host "PR #${prNumber}: $version"
          }

          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version-tag=v$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "is-release=$isRelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run Tests
        run: dotnet test tests/DrPodcast.Tests/DrPodcast.Tests.csproj --configuration Release --verbosity normal --collect:"XPlat Code Coverage"

  docker:
    needs: [determine-version, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: needs.determine-version.outputs.is-release == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ needs.determine-version.outputs.is-release == 'true' }}
            type=raw,value=${{ needs.determine-version.outputs.version-tag }},enable=${{ needs.determine-version.outputs.is-release == 'true' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ needs.determine-version.outputs.is-release == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        if: needs.determine-version.outputs.is-release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine-version.outputs.version-tag }}
          name: Release ${{ needs.determine-version.outputs.version-tag }}
          body: |
            ## Release ${{ needs.determine-version.outputs.version }}

            ### Docker

            ```bash
            docker pull ${{ env.IMAGE_NAME }}:${{ needs.determine-version.outputs.version-tag }}
            ```

            Or use `latest`:

            ```bash
            docker pull ${{ env.IMAGE_NAME }}:latest
            ```
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
