name: Update feeds

on:
  push:
    paths:
      - '.github/workflows/update-feed.yml'
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-feed:
    name: "Update ${{ matrix.podcasts.slug }} feed"
    runs-on: [ubuntu-24.04]

strategy:
    matrix:
      include: ${{fromJson(steps.load-podcasts.outputs.podcasts)}}

    steps:
    - name: Load podcasts data
      id: load-podcasts
      run: |
        echo "::set-output name=podcasts::$(jq -c . podcasts.json)"
      shell: bash
    - name: Get latest release
      id: get_latest_release
      run: |
        LATEST_RELEASE_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" | jq -r '.assets[0].browser_download_url')
        echo "Downloading latest release from $LATEST_RELEASE_URL"
        curl -L $LATEST_RELEASE_URL -o ommer.jar
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Execute ommer.jar
      run: java -jar ./ommer.jar ${SLUG} ${URN} ${IMAGE} ${{ secrets.API_KEY }} ${{ secrets.HOST_URL }}
      env:
        SLUG: ${{ matrix.podcasts.slug }}
        URN: ${{ matrix.podcasts.urn }}
        IMAGE: ${{ matrix.podcasts.image }}
    
    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Calculate MD5 of local feed.xml and base64 encode
      id: local_md5
      run: |
        MD5_HASH=$(md5sum output/${{ matrix.podcast[0] }}.xml | awk '{print $1}' | xxd -r -p | base64)
        echo "LOCAL_MD5=$MD5_HASH" >> $GITHUB_ENV
        echo "LOCAL_MD5=$MD5_HASH"
    
    - name: Get contentMd5 of the blob in Azure Blob Storage
      id: blob_md5
      continue-on-error: true
      run: |
        BLOB_PROPERTIES=$(az storage blob show \
          --account-name ${{ secrets.STORAGE_ACCOUNT }} \
          --container-name ${{ secrets.CONTAINER_NAME }} \
          --auth-mode login \
          --name ${{ matrix.podcasts.slug }}.xml \
          --query properties.contentSettings.contentMd5 -o tsv)
        echo "BLOB_MD5=$BLOB_PROPERTIES" >> $GITHUB_ENV
        echo "BLOB_MD5=$BLOB_PROPERTIES"
    
    - name: Upload feed.xml to Azure Blob Storage if different
      if: env.LOCAL_MD5 != env.BLOB_MD5
      run: |
        az storage blob upload \
          --account-name ${{ secrets.STORAGE_ACCOUNT }} \
          --container-name ${{ secrets.CONTAINER_NAME }} \
          --auth-mode login \
          --name ${{ matrix.podcasts.slug }}.xml \
          --file output/${{ matrix.podcasts.slug }}.xml \
          --overwrite

  generate-feedlist:
    runs-on: ubuntu-24.04
    needs: update-feed
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: List feed urls
        run: |
          az storage blob list \
            --account-name ${{ secrets.STORAGE_ACCOUNT }} \
            --container-name ${{ secrets.CONTAINER_NAME }} \
            --auth-mode login \
            --query "[].{name: name, url: properties.contentSettings.contentUri}" \
            --output table
