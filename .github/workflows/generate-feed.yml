name: Update feeds

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      use_prerelease:
        description: "Use prerelease"
        required: false
        type: boolean
        default: false
  push:
    paths:
      - "**/generate-feed.yml"
      - "**/podcasts.json"
      - "site/**"
  schedule:
    - cron: "0 * * * *"

jobs:
  update-and-deploy-feeds:
    name: "Update and deploy feeds"
    runs-on: ubuntu-24.04-arm
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download latest release
        env:
          GH_TOKEN: ${{ github.token }}
          USE_PRERELEASE: ${{ github.event.inputs.use_prerelease || 'false' }}
        shell: pwsh
        run: |
          Write-Host "Determining platform..."
          $platform = switch ("${{ runner.os }}") {
            "Linux" {
              if ("${{ runner.arch }}" -eq "ARM64") { "linux-arm64" } else { "linux-x64" }
            }
            "Windows" { "win-x64" }
            "macOS" { "osx-arm64" }
            default {
              Write-Error "Unsupported platform: ${{ runner.os }}"
              exit 1
            }
          }
          Write-Host "Detected platform: $platform"

          Write-Host "Determining release type..."
          $releaseFlag = if ($env:USE_PRERELEASE -eq "true") {
            Write-Host "Using prerelease"
          } else {
            Write-Host "Using latest stable release"
            "--exclude-pre-releases"
          }

          Write-Host "Getting latest release for $platform..."
          $releaseInfo = if ($releaseFlag) {
            gh release list --repo ${{ github.repository }} $releaseFlag --limit 1 --json tagName
          } else {
            gh release list --repo ${{ github.repository }} --limit 1 --json tagName
          }

          $releases = $releaseInfo | ConvertFrom-Json
          if (-not $releases -or $releases.Count -eq 0) {
            Write-Error "No releases found. Please create a release first."
            exit 1
          }
          $tagName = $releases[0].tagName

          Write-Host "Found release: $tagName"

          # Download the platform-specific asset
          $assetName = switch ($platform) {
            "linux-x64" { "DrPodcast-linux-x64" }
            "linux-arm64" { "DrPodcast-linux-arm64" }
            "win-x64" { "DrPodcast-win-x64.exe" }
            "osx-arm64" { "DrPodcast-osx-arm64" }
          }
          Write-Host "Downloading asset: $assetName"
          gh release download $tagName --repo ${{ github.repository }} --pattern "$assetName"

          # Prepare executable
          if ("${{ runner.os }}" -eq "Windows") {
            # Rename Windows executable to standard name
            Rename-Item -Path $assetName -NewName "DrPodcast.exe"      
          } else {
            # Rename and make executable for Unix systems
            Rename-Item -Path $assetName -NewName "DrPodcast"
            chmod +x DrPodcast
          }

          Write-Host "Downloaded and prepared release executable for $platform"

      - name: Run feed generator (generates feeds and website)
        env:
          API_KEY: ${{ secrets.API_KEY }}
          BASE_URL: ${{ secrets.BASE_URL }}
        shell: pwsh
        run: |
          if ("${{ runner.os }}" -eq "Windows") {
            & ./DrPodcast.exe --podcasts podcasts.json
          } else {
            & ./DrPodcast --podcasts podcasts.json
          }

      - name: Check for deployment changes
        id: deployment_check
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          $siteUrl = gh api "repos/$env:GITHUB_REPOSITORY/pages" --jq '.html_url'
          $needsDeploy = $false

          # Check if feeds directory exists and has files
          $feedsPath = "output/_site/feeds"
          if (-not (Test-Path $feedsPath)) {
            Write-Host "Feeds directory does not exist. No feeds generated."
            "needs_deploy=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          # Check each feed for changes
          $feeds = Get-ChildItem -Path "$feedsPath/*.xml" -ErrorAction SilentlyContinue
          if (-not $feeds) {
            Write-Host "No feed files found. Skipping deployment."
            "needs_deploy=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          foreach ($feed in $feeds) {
            $filename = $feed.Name

            # Get current hash
            $currentHash = (Get-FileHash -Path $feed.FullName -Algorithm SHA256).Hash.ToLower()

            # Try to get deployed file hash
            try {
              $deployedContent = Invoke-WebRequest -Uri "${siteUrl}feeds/$filename" -TimeoutSec 10 -ErrorAction Stop
              $deployedHash = (Get-FileHash -InputStream ([System.IO.MemoryStream]::new([System.Text.Encoding]::UTF8.GetBytes($deployedContent.Content))) -Algorithm SHA256).Hash.ToLower()
            } catch {
              $deployedHash = "none"
            }

            Write-Host "Checking $filename"
            Write-Host "Current hash: $currentHash"
            Write-Host "Deployed hash: $deployedHash"

            if ($currentHash -ne $deployedHash) {
              Write-Host "Changes detected in $filename"
              $needsDeploy = $true
              break
            }
          }

          if (-not $needsDeploy) {
            # Check if number of files changed
            try {
              $liveContent = Invoke-WebRequest -Uri $siteUrl -TimeoutSec 10 -ErrorAction Stop
              $liveCount = ([regex]::Matches($liveContent.Content, "class='feed-link'")).Count
            } catch {
              $liveCount = 0
            }
            $currentCount = (Get-ChildItem -Path "output/_site/feeds" -Filter "*.xml" -ErrorAction SilentlyContinue).Count
            
            if ($currentCount -ne $liveCount) {
              Write-Host "Number of XML files changed (current: $currentCount, live: $liveCount)"
              $needsDeploy = $true
            }
          }

          "needs_deploy=$needsDeploy" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Setup Pages
        if: steps.deployment_check.outputs.needs_deploy == 'true'
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: steps.deployment_check.outputs.needs_deploy == 'true'
        uses: actions/upload-pages-artifact@v4
        with:
          path: output/_site

      - name: Deploy to GitHub Pages
        if: steps.deployment_check.outputs.needs_deploy == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
